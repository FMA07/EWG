{% extends "base.html" %}
{% load static %}
{% block title %}Mapa{% endblock %}
{% block content %}

<div class="contenedor-mapa">
    <!--sidebar-->
    <div id="sidebar" class="sidebar" style="margin-top: 52px;">
        <button id="toggleSidebar" class="btn btn-sm btn-light">
            &lt;
        </button>
        <div id="sidebar-content"> <!--COlOCAR LEYENDA, CATEGORIAS, ETC usar for each TAMBIEN PONER EL FORM PARA LLENAR DATOS--> 
            <!--Colocar un condicional para que el texto desaparezca al escoger una opción-->
            <div id="sidebar-header">
                {% if user.is_authenticated %}
                <h6 id="titulo-sidebar">Escoja una categoría o cree una nueva (texto temporal)</h6>
                {% endif %}
            </div>
            <div id="sidebar-body">
                <ul style="list-style-type: none; line-height: 70%; margin-left: -20px;">
                    {% if user.is_authenticated %}
                    <hr class="sidebar-divider">
                    <li style="padding: 2px;">
                        <button class="sidebar-options" data-bs-toggle="modal" data-bs-target="#modalEstaticoCategoria">
                            Crear nueva categoría
                        </button>
                    </li>
                    {% endif %}
                    {% for element in categorias %}
                    <hr class="sidebar-divider">
                    <li>
                        <button class="sidebar-options">
                            {{element.nombre}}
                        </button>   
                    </li>
                    {% endfor %}
                    <!--Esta parte es de prueba para ver las figuras-->
                    
                </ul>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalEstaticoCategoria" tabindex="-1" aria-labelledby="modalEstaticoCategoria" aria-hidden="true" data-bs-keyboard="false" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="tituloModal">Nueva categoría</h1>
                    <button type="button" class="btn-close boton-cerrar" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="categoriaForm" method="POST" action="">
                        {% csrf_token %}
                        {{ formCategoria.as_p }}
                        <button type="button" class="btn btn-secondary boton-cerrar" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalEstaticoSubcategoria" tabindex="-1" aria-labelledby="modalEstaticoCategoria" aria-hidden="true" data-bs-keyboard="false" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="tituloModal">Nueva subcategoría</h1>
                    <button type="button" class="btn-close boton-cerrar" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="SubcategoriaForm" method="POST" action="">
                        {% csrf_token %}
                        {{ formSubcategoria.as_p}}
                        <button type="button" class="btn btn-secondary boton-cerrar" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="map">
    </div>
</div>



{% endblock %}

{% block extra_scripts %}
<!--------------------------------------LEAFLET Y MAPA DE OPS------------------------------------>
<!--Este link y script provienen de leaflet. Cargan los íconos y funcionalidades-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<!---------------------------------INICIA LEAFLET GEOMAN------------------------------------>
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css"/>
{% if user.is_authenticated %}
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.js"></script>
{% endif %}

<!--ESTE SCRIPT CARGA LOS DIFERENTES TILESETS Y DESPUÉS CARGA EL MAPA, INICIANDO CON EL DE LAS CALLES-->
<script>
    const calles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });
    const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Tiles © Esri'
    });
    const relieve = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenTopoMap contributors'
    })
    var map = L.map('map', {pmIgnore: false}).setView([-33.03853, -71.60666], 14);
    calles.addTo(map);
</script>
<!--ESTE SCRIPT PERMITE SELECCIONAR EL TILESET DEL MAPA-->
<script>
    let currentLayer = calles;
        
    const edicionesLayer = L.layerGroup().addTo(map);
        
    function cambiarMapa(layer){
        if (currentLayer) map.removeLayer(currentLayer);
        layer.addTo(map);
        currentLayer = layer;
    }
    //listeners para las distintas opciones del menú de mapas
    document.getElementById('mapaSatelital').addEventListener('click', function(e){
        e.preventDefault();
        cambiarMapa(satelite);
    });
    document.getElementById('mapaCalles').addEventListener('click', function(e){
        e.preventDefault();
        cambiarMapa(calles);
    });
    document.getElementById('mapaRelieve').addEventListener('click', function(e){
        e.preventDefault();
        cambiarMapa(relieve);
    });

</script>
<!--ESTE SCRIPT AÑADE LA BARRA DE HERRAMIENTAS DE GEOMAN-->
<script>
    map.pm.addControls({  
        position: 'topright',  
        drawCircleMarker: false,
        rotateMode: false,
        editMode: true,
        dragMode: true,
        removalMode: true,
        cutPolygon: false,
        drawText: false,
    }); 
</script>
<!-------------------------------------------------FUNCIONALIDADES VARIAS---------------------------------------->
<!--LISTENER--------->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        
        //----------SCRIPT PARA LA SIDEBAR------------------
        const sidebar = document.getElementById("sidebar");
        const toggleBtn = document.getElementById("toggleSidebar");

        toggleBtn.addEventListener("click", function () {
            sidebar.classList.toggle("minimized");
            setTimeout(() => {
                map.invalidateSize(); // Ajusta Leaflet después del cambio
            }, 310);

            if (sidebar.classList.contains("minimized")){
                toggleBtn.innerHTML = "&gt;"
            } else {
                toggleBtn.innerHTML = "&lt;"
            }
        });

        //------------------------SCRIPT PARA CARGAR LAS FIGURAS DEL LOCALSTORAGE-----------------
        
        const editableLayers = L.featureGroup().addTo(map);

        function cargarFiguras(){
            var figurasGuardadas = localStorage.getItem('todasLasFiguras');
            if (figurasGuardadas) {
                var geojson = JSON.parse(figurasGuardadas);
                L.geoJSON(geojson, {
                    onEachFeature: function(feature, layer){
                        editableLayers.addLayer(layer);
                        attachEditListeners(layer);
                    }
                }).addTo(map);
            }
        }
        
        //FUNCION PARA GUARDAR LAS FIGURAS EN EL LOCALSTORAGE
        function guardarFiguras(){
            var geojson = map.pm.getGeomanLayers(true).toGeoJSON();
            localStorage.setItem("todasLasFiguras", JSON.stringify(geojson));
        }

        //LISTENERS PARA EDITAR, MOVER Y ELIMINAR UNA FIGURA
        function attachEditListeners(layer){
            layer.on("pm:edit", guardarFiguras);
            layer.on("pm:dragend", guardarFiguras);
            layer.on("pm:remove", guardarFiguras);
        }

        //CREAR UNA NUEVA FIGURA
        map.on("pm:create", e =>{
            const layer = e.layer;
            editableLayers.addLayer(layer);
            attachEditListeners(layer);
            guardarFiguras();
        })
        
        cargarFiguras(); //PARA CARGAR LAS FIGURAS AL REFRESCAR LA PÁGINA

        //PARA ENVIAR LAS CATEGORIAS Y SUBCATEGORIAS A LA BASE DE DATOS POR AJAX
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const categoriaForm = document.getElementById('categoriaForm');
        
        categoriaForm.addEventListener('submit', function(e){
            e.preventDefault();

            const formData = new FormData(document.getElementById('categoriaForm'));
            formData.append('tipo_form', 'categoria')

            fetch('/guardar_por_ajax/', {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': csrftoken},
            })
            .then(response => response.json())
            .then(data => {
                if (data.success){
                    console.log("Guardado con éxito: ", data.nombre);
                } else {
                    console.error("Error: ", data.errors);
                }
            })
        })

        const subcategoriaForm = document.getElementById('SubcategoriaForm');

        subcategoriaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(subcategoriaForm);
            formData.append('tipo_form', 'subcategoria');

            fetch('/guardar_por_ajax/', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrftoken },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Subcategoría creada: " + data.nombre);
                } else {
                    console.error("Error:", data.errors);
                }
            });
        });
    });
</script>
{% endblock %}